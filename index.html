<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/websitebeaver/Jameel-Noori-Nastaleeq-Font/jameel-noori-nastaleeq-regular.ttf') format('truetype'); }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .urdu { font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif; direction: rtl; }
        .latin { font-family: 'Inter', sans-serif; direction: ltr; }
        .single-line-ellipsis { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .invoice-border { border: 1px solid #1f2937; }
        .input-underline { border: none; border-bottom: 1px solid #4b5563; padding: 2px 0; background-color: transparent; font-size: 0.9rem; }
        .input-underline:focus { outline: none; border-bottom: 2px solid #4f46e5; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2c3e50; color: white; padding: 10px 20px; border-radius: 25px; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-size: 1rem; }
        .toast.show { opacity: 1; bottom: 40px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; width: 95%; max-width: 800px; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 10px 20px; background-color: #f1f1f1; text-align: right; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; }
        @media print { body { background-color: white; } .no-print { display: none; } #invoice-container, .modal-content { box-shadow: none; border: none; } }
    </style>
</head>
<body class="p-2 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        <details class="bg-white rounded-xl shadow-sm p-4 no-print">
            <summary class="urdu font-bold text-xl cursor-pointer">کاروباری تفصیلات اور ڈیٹا بیک اپ</summary>
            <div class="mt-4 pt-4 border-t space-y-3">
                <input type="text" id="business-name-input" placeholder="کاروبار کا نام" class="urdu w-full p-2 border rounded">
                <input type="text" id="business-address-input" placeholder="ایڈریس" class="urdu w-full p-2 border rounded">
                <input type="text" id="business-phone-input" placeholder="فون نمبر" class="latin w-full p-2 border rounded text-right">
                <input type="text" id="terms-input" placeholder="شرائط و ضوابط" class="latin w-full p-2 border rounded">
                <div class="grid grid-cols-2 gap-4 border-t pt-4 mt-4">
                    <div>
                        <label for="font-size-slider" class="urdu block text-sm font-medium text-gray-700">کاروبار نام فونٹ سائز</label>
                        <input id="font-size-slider" type="range" min="16" max="40" value="28" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="position-slider" class="urdu block text-sm font-medium text-gray-700">پوزیشن (Left/Right)</label>
                        <input id="position-slider" type="range" min="-50" max="50" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                <button id="save-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded urdu w-full">سیٹنگز محفوظ کریں</button>
                 <div class="grid grid-cols-2 gap-4 mt-4">
                    <button id="backup-data-btn" class="bg-gray-600 text-white px-4 py-2 rounded urdu w-full">ڈیٹا بیک اپ</button>
                    <button id="restore-data-btn" class="bg-gray-700 text-white px-4 py-2 rounded urdu w-full">ڈیٹا ری سٹور</button>
                    <input type="file" id="restore-file-input" class="hidden" accept=".json">
                </div>
            </div>
        </details>

        <div id="invoice-container" class="bg-white invoice-border">
            <header class="p-4 md:p-6 pb-4 border-b-2 border-black">
                <div id="business-details-wrapper" class="w-full text-center relative mb-4 pt-2">
                    <!-- CORRECTION: Added py-1 to prevent font clipping at the bottom -->
                    <h1 id="display-business-name" class="urdu font-bold text-purple-700 single-line-ellipsis py-1"></h1>
                    <p id="display-business-address" class="urdu text-sm text-gray-600"></p>
                    <p id="display-business-phone" class="latin text-sm text-gray-600"></p>
                </div>
                <div class="flex justify-between items-end">
                    <div class="text-left latin space-y-0">
                        <div class="flex items-center"><strong class="w-16 shrink-0">Date:</strong><input type="date" id="invoice-date" class="input-underline flex-grow"></div>
                        <div class="flex items-center"><strong class="w-16 shrink-0">Name:</strong><input type="text" id="customer-name" class="input-underline flex-grow"></div>
                        <div class="flex items-center"><strong class="w-16 shrink-0">Ph. No.:</strong><input type="text" id="customer-phone" class="input-underline flex-grow"></div>
                    </div>
                    <div class="text-right latin">
                        <p class="mb-0"><strong>Bill No. :</strong> <input type="number" id="bill-no" class="input-underline w-24 md:w-20 font-bold text-red-600 text-lg text-right"></p>
                    </div>
                </div>
            </header>

            <div class="mt-2">
                <table class="w-full border-collapse">
                    <thead class="bg-gray-800 text-white latin">
                        <tr>
                            <th class="border border-black p-2 text-left w-[45%]">Item</th>
                            <th class="border border-black p-2 text-center w-[15%]">Qty.</th>
                            <th class="border border-black p-2 text-center w-[20%]">Rate</th>
                            <th class="border border-black p-2 text-center w-[20%]">Total</th>
                            <th class="no-print w-8"></th>
                        </tr>
                    </thead>
                    <tbody id="item-rows"></tbody>
                    <tfoot id="totals-section" class="bg-rose-50 font-bold latin text-purple-900">
                        <tr><td class="border border-black p-2 text-right" colspan="3">Total :</td><td id="sub-total" class="border border-black p-2 text-right" colspan="2">0</td></tr>
                        <tr><td class="border border-black p-2 text-right">Discount: <input type="number" id="discount-percent" value="0" class="w-12 text-center bg-transparent">%</td><td class="border border-black p-2 text-right" colspan="2">GST %: <input type="number" id="gst-percent" value="0" class="w-12 text-center bg-transparent">%</td><td id="grand-total" class="border border-black p-2 text-right text-lg" colspan="2">0</td></tr>
                        <tr><td class="border border-black p-2 text-right" colspan="3">Received :</td><td class="border border-black p-2" colspan="2"><input type="number" id="received-amount" value="0" class="w-full text-right bg-transparent font-bold"></td></tr>
                        <tr class="text-red-600 text-lg"><td class="border border-black p-2 text-right" colspan="3">Balance :</td><td id="balance-amount" class="border border-black p-2 text-right" colspan="2">0</td></tr>
                    </tfoot>
                </table>
                <div class="flex gap-4 mt-4 no-print px-4 md:px-6"><button id="add-row-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded urdu hover:bg-gray-300">+ نئی لائن</button><button id="remove-row-btn" class="bg-red-200 text-red-700 px-4 py-2 rounded urdu hover:bg-red-300">- لائن ختم کریں</button></div>
            </div>
            <footer class="mt-4 bg-gray-100 py-2 px-4 md:px-6 border border-black"><p id="display-terms" class="latin text-sm"></p></footer>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6 no-print">
            <button id="new-bill-btn" class="w-full bg-gray-500 text-white py-3 rounded-lg urdu text-lg font-bold">نیا بل</button><button id="save-bill-btn" class="w-full bg-green-500 text-white py-3 rounded-lg urdu text-lg font-bold">محفوظ کریں</button><button id="preview-btn" class="w-full bg-purple-500 text-white py-3 rounded-lg urdu text-lg font-bold">پریویو</button><button id="print-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg urdu text-lg font-bold">پرنٹ / PDF</button><button id="share-btn" class="w-full bg-teal-500 text-white py-3 rounded-lg urdu text-lg font-bold">تصویر بھیجیں</button>
        </div>
        <details class="bg-white rounded-xl shadow-sm p-4 no-print" open><summary class="urdu font-bold text-xl cursor-pointer">محفوظ شدہ بلز کی ہسٹری</summary><div id="history-list" class="mt-4 pt-4 border-t space-y-2"></div></details>
        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-75 flex flex-col items-center justify-center hidden z-50"><div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div><p class="urdu mt-4 text-lg">برائے مہربانی انتظار کریں...</p></div>
    </div>
    <div id="preview-modal" class="modal"><div class="modal-content"><div id="preview-content" class="modal-body"></div><div class="modal-footer no-print"><button id="preview-share-btn" class="bg-teal-500 text-white px-4 py-2 rounded urdu">تصویر بھیجیں</button><button id="preview-print-btn" class="bg-blue-500 text-white px-4 py-2 rounded urdu">پرنٹ کریں</button><button id="preview-close-btn" class="bg-gray-500 text-white px-4 py-2 rounded urdu">بند کریں</button></div></div></div>

<!-- SCRIPT SECTION (No changes here) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const SETTINGS_KEY = 'invoiceApp_settings_final_v6'; const HISTORY_KEY = 'invoiceApp_history_final_v6'; const BILL_NO_KEY = 'invoiceApp_billNo_final_v6';
    const dom = {
        settings: { name: document.getElementById('business-name-input'), address: document.getElementById('business-address-input'), phone: document.getElementById('business-phone-input'), terms: document.getElementById('terms-input'), fontSizeSlider: document.getElementById('font-size-slider'), positionSlider: document.getElementById('position-slider'), saveBtn: document.getElementById('save-settings-btn') },
        display: { wrapper: document.getElementById('business-details-wrapper'), name: document.getElementById('display-business-name'), address: document.getElementById('display-business-address'), phone: document.getElementById('display-business-phone'), terms: document.getElementById('display-terms') },
        invoice: { date: document.getElementById('invoice-date'), billNo: document.getElementById('bill-no'), customerName: document.getElementById('customer-name'), customerPhone: document.getElementById('customer-phone') },
        itemRows: document.getElementById('item-rows'), addRowBtn: document.getElementById('add-row-btn'), removeRowBtn: document.getElementById('remove-row-btn'),
        summary: { subTotal: document.getElementById('sub-total'), discountPercent: document.getElementById('discount-percent'), gstPercent: document.getElementById('gst-percent'), grandTotal: document.getElementById('grand-total'), received: document.getElementById('received-amount'), balance: document.getElementById('balance-amount') },
        actionBtns: { new: document.getElementById('new-bill-btn'), save: document.getElementById('save-bill-btn'), print: document.getElementById('print-btn'), share: document.getElementById('share-btn'), preview: document.getElementById('preview-btn') },
        historyList: document.getElementById('history-list'), loader: document.getElementById('loader'), backupBtn: document.getElementById('backup-data-btn'), restoreBtn: document.getElementById('restore-data-btn'), restoreFileInput: document.getElementById('restore-file-input'),
        previewModal: document.getElementById('preview-modal'), previewContent: document.getElementById('preview-content'), previewShareBtn: document.getElementById('preview-share-btn'), previewPrintBtn: document.getElementById('preview-print-btn'), previewCloseBtn: document.getElementById('preview-close-btn')
    };
    let activeBillId = null;
    function initializeApp() { loadSettings(); loadHistory(); resetForm(false); attachEventListeners(); }
    function attachEventListeners() {
        dom.settings.saveBtn.addEventListener('click', saveSettings);
        dom.addRowBtn.addEventListener('click', () => addNewRow());
        dom.removeRowBtn.addEventListener('click', removeLastRow);
        dom.settings.fontSizeSlider.addEventListener('input', applyCustomStyles);
        dom.settings.positionSlider.addEventListener('input', applyCustomStyles);
        dom.itemRows.addEventListener('input', e => { if (e.target.matches('.qty, .rate')) calculateRow(e.target); });
        dom.itemRows.addEventListener('change', e => { if (e.target.matches('.rate')) { formatRateInput(e.target); } });
        dom.itemRows.addEventListener('click', e => { if (e.target.closest('.delete-row-btn')) deleteRow(e.target.closest('.delete-row-btn')); });
        ['discount-percent', 'gst-percent', 'received-amount'].forEach(id => { document.getElementById(id).addEventListener('input', calculateTotals); });
        dom.actionBtns.new.addEventListener('click', () => resetForm(true)); dom.actionBtns.save.addEventListener('click', saveBill); dom.actionBtns.print.addEventListener('click', () => window.print()); dom.actionBtns.share.addEventListener('click', () => shareAsImage()); dom.actionBtns.preview.addEventListener('click', showPreview);
        dom.previewShareBtn.addEventListener('click', () => shareAsImage(dom.previewContent)); dom.previewPrintBtn.addEventListener('click', printPreview); dom.previewCloseBtn.addEventListener('click', () => dom.previewModal.style.display = 'none');
        dom.historyList.addEventListener('click', (e) => { const loadBtn = e.target.closest('.load-bill-btn'); const deleteBtn = e.target.closest('.delete-bill-btn'); if (loadBtn) loadBill(loadBtn.dataset.id); if (deleteBtn) deleteBill(deleteBtn.dataset.id); });
        dom.backupBtn.addEventListener('click', backupData); dom.restoreBtn.addEventListener('click', () => dom.restoreFileInput.click()); dom.restoreFileInput.addEventListener('change', restoreData);
    }
    
    function applyCustomStyles() {
        const fontSize = dom.settings.fontSizeSlider.value;
        const positionValue = dom.settings.positionSlider.value;
        if (dom.display.name) { dom.display.name.style.fontSize = `${fontSize}px`; }
        dom.display.wrapper.style.transform = `translateX(${positionValue}px)`;
    }

    function formatNumber(num) {
        let number = parseFloat(String(num).replace(/,/g, '')) || 0;
        if (number % 1 === 0) {
            return number.toLocaleString('en-US');
        } else {
            const roundedNumber = Math.round(number * 100) / 100;
            return roundedNumber.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    }
    
    function formatRateInput(inputElement) {
        if (!inputElement || !inputElement.value.trim()) return;
        const value = parseFloat(inputElement.value);
        if (!isNaN(value)) {
            if (value % 1 === 0) { inputElement.value = value; } 
            else { inputElement.value = value.toFixed(2); }
        }
    }

    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
        dom.settings.name.value = settings.name || ''; dom.settings.address.value = settings.address || ''; dom.settings.phone.value = settings.phone || ''; dom.settings.terms.value = settings.terms || '';
        dom.settings.fontSizeSlider.value = settings.fontSize || '28';
        dom.settings.positionSlider.value = settings.position || '0';
        updateDisplayInfo(); applyCustomStyles();
    }
    function saveSettings() {
        const settings = { name: dom.settings.name.value, address: dom.settings.address.value, phone: dom.settings.phone.value, terms: dom.settings.terms.value, fontSize: dom.settings.fontSizeSlider.value, position: dom.settings.positionSlider.value };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        updateDisplayInfo(); applyCustomStyles(); showToast('سیٹنگز محفوظ ہو گئیں۔');
    }
    function updateDisplayInfo() {
        dom.display.name.textContent = dom.settings.name.value || 'کاروبار کا نام'; dom.display.address.textContent = dom.settings.address.value; dom.display.phone.textContent = dom.settings.phone.value;
        dom.display.terms.textContent = dom.settings.terms.value;
    }
    function getNextBillNo() { return parseInt(localStorage.getItem(BILL_NO_KEY) || '1'); }
    
    function addNewRow(item = { name: '', qty: '', rate: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `<td class="border border-black"><input type="text" placeholder="Enter item name" class="item-name w-full p-2 latin text-left bg-transparent" value="${item.name}"></td><td class="border border-black"><input type="number" value="${item.qty}" class="qty w-full p-2 text-center latin bg-transparent"></td><td class="border border-black"><input type="number" step="any" class="rate w-full p-2 text-center latin bg-transparent" value="${item.rate}"></td><td class="border border-black"><input type="text" class="total w-full p-2 text-right latin bg-transparent font-bold" readonly></td><td class="no-print text-center align-middle"><button class="delete-row-btn text-red-500 hover:text-red-700 p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75a1.25 1.25 0 00-1.25-1.25h-2.5A1.25 1.25 0 007.5 3.75v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg></button></td>`;
        dom.itemRows.appendChild(row);
        
        if (item.rate) {
            const rateInput = row.querySelector('.rate');
            formatRateInput(rateInput);
            calculateRow(rateInput);
        }
    }
    
    function removeLastRow() { if (dom.itemRows.children.length > 1) { dom.itemRows.removeChild(dom.itemRows.lastElementChild); calculateTotals(); } else { showToast('کم از کم ایک لائن ضروری ہے۔'); } }
    function deleteRow(button) { if (dom.itemRows.children.length > 1) { button.closest('tr').remove(); calculateTotals(); } else { showToast('کم از کم ایک لائن ضروری ہے۔'); } }

    function calculateRow(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const rate = parseFloat(row.querySelector('.rate').value) || 0;
        const total = qty * rate;

        if (total % 1 === 0) {
            row.querySelector('.total').value = total;
        } else {
            row.querySelector('.total').value = total.toFixed(2);
        }
        
        calculateTotals();
    }

    function calculateTotals() {
        let subTotal = 0; 
        dom.itemRows.querySelectorAll('tr').forEach(row => { 
            const totalValue = row.querySelector('.total').value.replace(/,/g, '');
            subTotal += parseFloat(totalValue) || 0; 
        });
        dom.summary.subTotal.textContent = formatNumber(subTotal);
        const discountPercent = parseFloat(dom.summary.discountPercent.value) || 0; const discountAmount = (subTotal * discountPercent) / 100;
        const totalAfterDiscount = subTotal - discountAmount;
        const gstPercent = parseFloat(dom.summary.gstPercent.value) || 0; const gstAmount = (totalAfterDiscount * gstPercent) / 100;
        const grandTotal = totalAfterDiscount + gstAmount; dom.summary.grandTotal.textContent = formatNumber(grandTotal);
        const received = parseFloat(dom.summary.received.value.replace(/,/g, '')) || 0; const balance = grandTotal - received;
        dom.summary.balance.textContent = formatNumber(balance);
    }
    function getHistory() { try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); } catch (e) { return []; } }
    function saveHistory(history) { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }
    function loadHistory() { const history = getHistory(); dom.historyList.innerHTML = history.map(bill => `<div class="flex justify-between items-center p-2 border-b hover:bg-slate-50"><div class="urdu text-right"><strong>${bill.customerName}</strong><br><span class="text-sm text-gray-600">بل نمبر: ${bill.billNo} | تاریخ: ${new Date(bill.date).toLocaleDateString('en-GB')}</span></div><div><button class="load-bill-btn bg-blue-100 text-blue-600 px-3 py-1 text-sm rounded-full urdu" data-id="${bill.id}">لوڈ کریں</button><button class="delete-bill-btn bg-red-100 text-red-600 px-3 py-1 text-sm rounded-full urdu" data-id="${bill.id}">حذف کریں</button></div></div>`).join(''); }
    function loadBill(id) {
        const bill = getHistory().find(b => b.id == id); if (!bill) return; activeBillId = bill.id;
        dom.invoice.date.value = bill.date; dom.invoice.billNo.value = bill.billNo; dom.invoice.customerName.value = bill.customerName; dom.invoice.customerPhone.value = bill.customerPhone;
        dom.display.terms.textContent = bill.terms;
        dom.itemRows.innerHTML = ''; bill.items.forEach(item => addNewRow(item));
        dom.summary.discountPercent.value = bill.summary.discountPercent; dom.summary.gstPercent.value = bill.summary.gstPercent; dom.summary.received.value = bill.summary.received;
        calculateTotals(); window.scrollTo(0, 0); showToast(`بل نمبر ${bill.billNo} لوڈ ہو گیا۔`);
    }
    function deleteBill(id) { if (confirm('کیا آپ واقعی اس بل کو حذف کرنا چاہتے ہیں؟')) { let history = getHistory().filter(b => b.id != id); saveHistory(history); loadHistory(); showToast('بل حذف کر دیا گیا۔'); if (activeBillId == id) { resetForm(true); } } }
    
    function resetForm(isNewBill) {
        activeBillId = null;
        document.getElementById('invoice-container').querySelectorAll('input:not(#bill-no)').forEach(input => {
            if (input.type === 'number') input.value = '0';
            else if (input.type !== 'date') input.value = '';
        });
        dom.invoice.date.valueAsDate = new Date();
        if (isNewBill) {
            dom.invoice.billNo.value = getNextBillNo();
        } else if (!dom.invoice.billNo.value) {
            dom.invoice.billNo.value = getNextBillNo();
        }
        dom.itemRows.innerHTML = ''; let defaultRows = 6; for (let i = 0; i < defaultRows; i++) addNewRow();
        calculateTotals(); dom.invoice.customerName.focus();
    }

    function saveBill() {
        if (!dom.invoice.customerName.value.trim()) { showToast('براہ کرم کسٹمر کا نام درج کریں۔', 'error'); dom.invoice.customerName.focus(); return; }
        const history = getHistory(); const existingBillIndex = history.findIndex(b => b.id === activeBillId);
        const bill = { id: activeBillId || Date.now(), date: dom.invoice.date.value, billNo: dom.invoice.billNo.value, customerName: dom.invoice.customerName.value, customerPhone: dom.invoice.customerPhone.value, terms: dom.display.terms.textContent, items: Array.from(dom.itemRows.querySelectorAll('tr')).map(row => ({ name: row.querySelector('.item-name').value, qty: row.querySelector('.qty').value, rate: row.querySelector('.rate').value })), summary: { discountPercent: dom.summary.discountPercent.value, gstPercent: dom.summary.gstPercent.value, received: dom.summary.received.value } };
        if (existingBillIndex > -1) { history[existingBillIndex] = bill; showToast(`بل نمبر ${bill.billNo} اپ ڈیٹ ہو گیا۔`); } else { history.unshift(bill); localStorage.setItem(BILL_NO_KEY, parseInt(bill.billNo) + 1); showToast('بل کامیابی سے محفوظ ہو گیا۔'); }
        saveHistory(history); loadHistory(); 
        if (existingBillIndex === -1) { 
             resetForm(true);
        }
    }
    async function shareAsImage(elementToCapture = document.getElementById('invoice-container')) {
        dom.loader.classList.remove('hidden'); dom.loader.classList.add('flex');
        await new Promise(resolve => setTimeout(resolve, 50));
        try {
            const canvas = await html2canvas(elementToCapture, { scale: 2, backgroundColor: '#ffffff' });
            canvas.toBlob(async (blob) => {
                if (!blob) { throw new Error('Canvas to Blob conversion failed'); }
                const file = new File([blob], 'invoice.png', { type: 'image/png' });
                const customerName = dom.invoice.customerName.value || 'invoice'; const billNo = dom.invoice.billNo.value || 'N/A';
                if (navigator.share) { await navigator.share({ files: [file], title: `Bill for ${customerName}`, text: `Bill No: ${billNo}` }); } else { const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Invoice-${billNo}.png`; link.click(); URL.revokeObjectURL(link.href); }
            }, 'image/png');
        } catch (err) { console.error('Sharing failed:', err); showToast('شیئر کرنے میں ناکامی ہوئی۔');
        } finally { dom.loader.classList.add('hidden'); dom.loader.classList.remove('flex'); }
    }

    function showPreview() {
        const invoiceClone = document.getElementById('invoice-container').cloneNode(true);
        invoiceClone.querySelector('#display-business-name').style.fontSize = dom.display.name.style.fontSize;
        invoiceClone.querySelector('#display-business-name').textContent = dom.display.name.textContent;
        invoiceClone.querySelector('#display-business-address').textContent = dom.display.address.textContent;
        invoiceClone.querySelector('#display-business-phone').textContent = dom.display.phone.textContent;
        invoiceClone.querySelector('#display-terms').textContent = dom.display.terms.textContent;
        invoiceClone.querySelectorAll('input').forEach(input => {
            const displayEl = document.createElement('span');
            displayEl.className = input.className.replace(/input-underline|bg-transparent|w-full|flex-grow|ml-1/g, '');
            if (input.type === 'date') { const dateValue = new Date(input.value); if (!isNaN(dateValue)) { displayEl.textContent = dateValue.toLocaleDateString('en-GB'); } else { displayEl.textContent = '';} } 
            else {
                const isNumericField = input.classList.contains('qty') || input.classList.contains('rate') || input.classList.contains('total') || input.id === 'received-amount';
                if (isNumericField && input.value) {
                    displayEl.textContent = formatNumber(input.value);
                } else {
                    displayEl.textContent = input.value;
                }
            }
            input.parentElement.replaceChild(displayEl, input);
        });
        invoiceClone.querySelectorAll('.no-print').forEach(el => el.remove());
        dom.previewContent.innerHTML = ''; dom.previewContent.appendChild(invoiceClone); dom.previewModal.style.display = 'block';
    }

    function printPreview() { const content = dom.previewContent.innerHTML; const printWindow = window.open('', '', 'height=800,width=800'); printWindow.document.write(`<html><head><title>Print</title><script src="https://cdn.tailwindcss.com"><\/script><style>.urdu{font-family:"Jameel Noori Nastaleeq",serif;direction:rtl;} .latin{font-family:"Inter",sans-serif;} .invoice-border{border: 1px solid #1f2937;}</style></head><body>${content}</body></html>`); printWindow.document.close(); setTimeout(() => { printWindow.print(); }, 500); }
    function backupData() { const data = { settings: JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'), history: getHistory(), billNo: localStorage.getItem(BILL_NO_KEY) || '1' }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoice-backup-${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(a.href); }
    function restoreData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.settings && data.history && data.billNo) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(data.settings)); saveHistory(data.history); localStorage.setItem(BILL_NO_KEY, data.billNo); loadSettings(); loadHistory(); resetForm(false); showToast('ڈیٹا کامیابی سے ری سٹور ہو گیا۔'); } else { throw new Error("Invalid backup file"); } } catch (err) { showToast('بیک اپ فائل درست نہیں ہے۔', 'error'); } }; reader.readAsText(file); }
    function showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = 'toast urdu'; toast.textContent = message; if (type === 'error') { toast.style.backgroundColor = '#e74c3c'; } document.body.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => document.body.removeChild(toast), 500); }, 3000); }
    initializeApp();
});
</script>

</body>
</html>